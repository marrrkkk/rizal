<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Progress System Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>SQLite Progress System Test</h1>

    <div class="test-section">
      <h3>Authentication</h3>
      <input
        type="text"
        id="username"
        placeholder="Username"
        value="testuser"
      />
      <input
        type="password"
        id="password"
        placeholder="Password"
        value="password"
      />
      <button onclick="login()">Login</button>
      <div id="auth-status"></div>
    </div>

    <div class="test-section">
      <h3>Progress Operations</h3>
      <button onclick="initializeProgress()">Initialize Progress</button>
      <button onclick="getProgress()">Get Progress</button>
      <button onclick="completeLevel()">Complete Level 1-1</button>
      <div id="progress-status"></div>
    </div>

    <div class="test-section">
      <h3>Response Data</h3>
      <pre id="response-data"></pre>
    </div>

    <script>
      let authToken = localStorage.getItem("token");

      async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        try {
          const response = await fetch(
            "http://localhost/rizal/api/auth/login.php",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            }
          );

          const data = await response.json();

          if (data.token) {
            authToken = data.token;
            localStorage.setItem("token", authToken);
            document.getElementById("auth-status").innerHTML =
              '<span class="success">✓ Logged in successfully</span>';
          } else {
            document.getElementById("auth-status").innerHTML =
              '<span class="error">✗ Login failed: ' +
              (data.error || "Unknown error") +
              "</span>";
          }

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("auth-status").innerHTML =
            '<span class="error">✗ Login error: ' + error.message + "</span>";
        }
      }

      async function initializeProgress() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/rizal/api/progress/initialize_progress.php",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
            }
          );

          const data = await response.json();
          document.getElementById("progress-status").innerHTML = data.success
            ? '<span class="success">✓ Progress initialized</span>'
            : '<span class="error">✗ Failed to initialize: ' +
              data.error +
              "</span>";

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("progress-status").innerHTML =
            '<span class="error">✗ Error: ' + error.message + "</span>";
        }
      }

      async function getProgress() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/rizal/api/progress/get_progress.php",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
            }
          );

          const data = await response.json();
          document.getElementById("progress-status").innerHTML = data.chapters
            ? '<span class="success">✓ Progress loaded</span>'
            : '<span class="error">✗ Failed to load progress</span>';

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("progress-status").innerHTML =
            '<span class="error">✗ Error: ' + error.message + "</span>";
        }
      }

      async function completeLevel() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/rizal/api/progress/complete_level.php",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
              body: JSON.stringify({
                chapter: 1,
                level: 1,
                score: 85,
              }),
            }
          );

          const data = await response.json();
          document.getElementById("progress-status").innerHTML = data.success
            ? '<span class="success">✓ Level completed</span>'
            : '<span class="error">✗ Failed to complete level: ' +
              data.error +
              "</span>";

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("progress-status").innerHTML =
            '<span class="error">✗ Error: ' + error.message + "</span>";
        }
      }

      // Check if already logged in
      if (authToken) {
        document.getElementById("auth-status").innerHTML =
          '<span class="success">✓ Already logged in</span>';
      }
    </script>
  </body>
</html>
