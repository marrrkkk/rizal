<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SQLite Auth System Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
      }
      input {
        padding: 8px;
        margin: 5px;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
        max-height: 300px;
      }
      .user-info {
        background: #e8f4fd;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>SQLite Auth System Test</h1>

    <div class="test-section">
      <h3>Authentication</h3>
      <div>
        <input
          type="text"
          id="username"
          placeholder="Username"
          value="testuser"
        />
        <input
          type="password"
          id="password"
          placeholder="Password"
          value="password"
        />
        <button onclick="login()">Login</button>
        <button onclick="logout()">Logout</button>
      </div>
      <div id="auth-status"></div>
      <div id="user-info" class="user-info" style="display: none"></div>
    </div>

    <div class="test-section">
      <h3>User Registration</h3>
      <div>
        <input type="text" id="reg-username" placeholder="New Username" />
        <input type="password" id="reg-password" placeholder="New Password" />
        <button onclick="register()">Register New User</button>
      </div>
      <div id="register-status"></div>
    </div>

    <div class="test-section">
      <h3>User Profile</h3>
      <button onclick="getProfile()">Get Profile</button>
      <button onclick="getProtectedData()">Get Protected Data</button>
      <div id="profile-status"></div>
    </div>

    <div class="test-section">
      <h3>Progress Operations</h3>
      <button onclick="initializeProgress()">Initialize Progress</button>
      <button onclick="getProgress()">Get Progress</button>
      <button onclick="completeLevel()">Complete Level 1-1</button>
      <div id="progress-status"></div>
    </div>

    <div class="test-section">
      <h3>Password Management</h3>
      <div>
        <input
          type="password"
          id="current-password"
          placeholder="Current Password"
        />
        <input type="password" id="new-password" placeholder="New Password" />
        <button onclick="changePassword()">Change Password</button>
      </div>
      <div id="password-status"></div>
    </div>

    <div class="test-section">
      <h3>Response Data</h3>
      <button onclick="clearResponse()">Clear</button>
      <pre id="response-data"></pre>
    </div>

    <script>
      let authToken = localStorage.getItem("token");
      let currentUser = null;

      function updateAuthStatus() {
        if (authToken && currentUser) {
          document.getElementById(
            "auth-status"
          ).innerHTML = `<span class="success">✓ Logged in as ${currentUser.username}</span>`;
          document.getElementById("user-info").style.display = "block";
          document.getElementById(
            "user-info"
          ).innerHTML = `<strong>User:</strong> ${currentUser.username}<br>
                     <strong>ID:</strong> ${currentUser.id}<br>
                     <strong>Created:</strong> ${currentUser.created_at}`;
        } else {
          document.getElementById("auth-status").innerHTML =
            '<span class="error">Not logged in</span>';
          document.getElementById("user-info").style.display = "none";
        }
      }

      async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        try {
          const response = await fetch(
            "http://localhost/rizal/api/auth/login.php",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            }
          );

          const data = await response.json();

          if (data.token) {
            authToken = data.token;
            currentUser = data.user;
            localStorage.setItem("token", authToken);
            updateAuthStatus();
          } else {
            document.getElementById("auth-status").innerHTML =
              '<span class="error">✗ Login failed: ' +
              (data.error || "Unknown error") +
              "</span>";
          }

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("auth-status").innerHTML =
            '<span class="error">✗ Login error: ' + error.message + "</span>";
        }
      }

      function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem("token");
        updateAuthStatus();
        document.getElementById("response-data").textContent = "Logged out";
      }

      async function register() {
        const username = document.getElementById("reg-username").value;
        const password = document.getElementById("reg-password").value;

        if (!username || !password) {
          alert("Please enter username and password");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/rizal/api/auth/register.php",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            }
          );

          const data = await response.json();

          document.getElementById("register-status").innerHTML = data.message
            ? '<span class="success">✓ ' + data.message + "</span>"
            : '<span class="error">✗ Registration failed: ' +
              (data.error || "Unknown error") +
              "</span>";

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("register-status").innerHTML =
            '<span class="error">✗ Registration error: ' +
            error.message +
            "</span>";
        }
      }

      async function getProfile() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/rizal/api/auth/profile.php",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
            }
          );

          const data = await response.json();
          document.getElementById("profile-status").innerHTML = data.user
            ? '<span class="success">✓ Profile loaded</span>'
            : '<span class="error">✗ Failed to load profile</span>';

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("profile-status").innerHTML =
            '<span class="error">✗ Error: ' + error.message + "</span>";
        }
      }

      async function getProtectedData() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/rizal/api/auth/protected.php",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
            }
          );

          const data = await response.json();
          document.getElementById("profile-status").innerHTML = data.message
            ? '<span class="success">✓ Protected data accessed</span>'
            : '<span class="error">✗ Failed to access protected data</span>';

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("profile-status").innerHTML =
            '<span class="error">✗ Error: ' + error.message + "</span>";
        }
      }

      async function initializeProgress() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/rizal/api/progress/initialize_progress.php",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
            }
          );

          const data = await response.json();
          document.getElementById("progress-status").innerHTML = data.success
            ? '<span class="success">✓ Progress initialized</span>'
            : '<span class="error">✗ Failed to initialize: ' +
              data.error +
              "</span>";

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("progress-status").innerHTML =
            '<span class="error">✗ Error: ' + error.message + "</span>";
        }
      }

      async function getProgress() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/rizal/api/progress/get_progress.php",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
            }
          );

          const data = await response.json();
          document.getElementById("progress-status").innerHTML = data.chapters
            ? '<span class="success">✓ Progress loaded</span>'
            : '<span class="error">✗ Failed to load progress</span>';

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("progress-status").innerHTML =
            '<span class="error">✗ Error: ' + error.message + "</span>";
        }
      }

      async function completeLevel() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/rizal/api/progress/complete_level.php",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
              body: JSON.stringify({
                chapter: 1,
                level: 1,
                score: 85,
              }),
            }
          );

          const data = await response.json();
          document.getElementById("progress-status").innerHTML = data.success
            ? '<span class="success">✓ Level completed</span>'
            : '<span class="error">✗ Failed to complete level: ' +
              data.error +
              "</span>";

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("progress-status").innerHTML =
            '<span class="error">✗ Error: ' + error.message + "</span>";
        }
      }

      async function changePassword() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        const currentPassword =
          document.getElementById("current-password").value;
        const newPassword = document.getElementById("new-password").value;

        if (!currentPassword || !newPassword) {
          alert("Please enter both current and new passwords");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost/rizal/api/auth/change_password.php",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
              body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword,
              }),
            }
          );

          const data = await response.json();
          document.getElementById("password-status").innerHTML = data.success
            ? '<span class="success">✓ Password changed successfully</span>'
            : '<span class="error">✗ Failed to change password: ' +
              data.error +
              "</span>";

          document.getElementById("response-data").textContent = JSON.stringify(
            data,
            null,
            2
          );

          // Clear password fields
          document.getElementById("current-password").value = "";
          document.getElementById("new-password").value = "";
        } catch (error) {
          document.getElementById("password-status").innerHTML =
            '<span class="error">✗ Error: ' + error.message + "</span>";
        }
      }

      function clearResponse() {
        document.getElementById("response-data").textContent = "";
      }

      // Initialize on page load
      updateAuthStatus();

      // Check if already logged in
      if (authToken) {
        // Try to get user info from protected endpoint
        getProtectedData();
      }
    </script>
  </body>
</html>
